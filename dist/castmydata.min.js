!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){var e,i={};if("object"==typeof t&&"undefined"!=typeof module){var n=require("node-localstorage").LocalStorage;e=new n("./scratch")}!function(t){"use strict";function i(t){var e,i=[],n={};for(e in t)i.push([e,t[e]]);i.sort(function(t,e){return e[1]-t[1]});for(e in i)n[i[e][0]]=i[e][1];return n}function n(t){var e,i=t[t.length-1],o=t.substring(0,t.length-1);return"undefined"==typeof i?e="a":"z"===i?e="A":"Z"===i?(e="a",o=""!==o?n(o):"a"):e=String.fromCharCode(i.charCodeAt(0)+1),i=e,o+i}function o(t){var e,o,s={},r="",c=t.match(u);for(e in c)c[e].length>r.length+2&&("undefined"!=typeof s[c[e]]?s[c[e]]+=1:s[c[e]]=0);o=i(s);for(e in o)r=n(r),o[e]=a+r+a;return o}function s(t,e){var i,n;for(i in e)n=new RegExp(i,"g"),t=t.replace(n,e[i]);return t}function r(t,e){var i,n;for(i in e)n=new RegExp(e[i],"g"),t=t.replace(n,i);return t}function c(){this.setItem=function(t,i,n){var r,c,u;return"undefined"!=typeof n&&"no-beautify"===n||(c=JSON.parse(i),i=JSON.stringify(c)),u=o(i),r=s(i,u),"undefined"!=typeof n&&"local-dict"===n?d[t]=u:e.setItem(t,r),"undefined"==typeof d[t]&&e.setItem("d_"+t,JSON.stringify(u)),r},this.getItem=function(t){var i,n;return i=e.getItem(t),n="undefined"==typeof d[t]?JSON.parse(e.getItem("d_"+t)):d[t],r(i,n)},this.getDict=function(t){var i;return i="undefined"==typeof d[t]?JSON.parse(e.getItem("d_"+t)):d[t]},this.setDict=function(t,i,n){"undefined"==typeof n?e.setItem("d_"+t,i):d[t]=i}}var u=/\"[a-zA-Z0-9]*\":/g,a="Â£",d={};t.JJLC=new c}(i),i.localStorage=i.JJLC,function(t){for(var e=[],i=0;15>=i;i++)e[i]=i.toString(16);var n={v4:function(){for(var t="",i=1;36>=i;i++)t+=9===i||14===i||19===i||24===i?"-":15===i?4:20===i?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=n}(i);var o=function(){function t(t){this.head=new e,this.tail=new e(this.head),this.head.next=this.tail,this.linkConstructor=t,this.reg={}}function e(t,e,n){this.prev=t,this.next=e,this.fn=n||i}function i(){}function n(){this._events={}}var o=0;return t.prototype={insert:function(t){var i=new e(this.tail.prev,this.tail,t);return i.next.prev=i.prev.next=i,i},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev}},e.prototype.run=function(t){this.fn(t),this.next&&this.next.run(t)},n.prototype={on:function(e,i){var n=this;return e.split(/\W+/g).forEach(function(e){var s=n._events[e]||(n._events[e]=new t),r=i._eev||(i._eev=++o);s.reg[r]||(s.reg[r]=s.insert(i))}),this},off:function(t,e){var i=this;return t.split(/\W+/g).forEach(function(t){var n=i._events[t],o=n.reg[e._eev];n.reg[e._eev]=void 0,n&&o&&n.remove(o)}),this},emit:function(t,e){var i=this._events[t];return i&&i.head.run(e),this}},n}();Object.deepExtend=function(t,e){for(var i in e)e[i]&&e[i].constructor&&e[i].constructor===Object?(t[i]=t[i]||{},arguments.callee(t[i],e[i])):t[i]=e[i];return t};var s=function(t,e){e=e||{},this.id=e.id||i.uuid.v4(),this.attributes=e.attributes||{},this.meta=e.meta||{},this._events={},this._endpoint=t};s.prototype=Object.create(o.prototype),s.prototype.get=function(){return JSON.parse(JSON.stringify({id:this.id,attributes:this.attributes,meta:this.meta}))},s.prototype.post=function(t){t.meta={synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null},Object.deepExtend(this,t),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.emit("post",this.get())},s.prototype.put=function(t){Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.emit("put",this.get())},s.prototype["delete"]=function(){this.attributes={},this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.emit("delete",this.id)},s.prototype.merge=function(t){return JSON.stringify(this.attributes)!=JSON.stringify(t.attributes)||JSON.stringify(this.meta)!=JSON.stringify(t.meta)?(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this),!0):!1};var r=function(t,e,n){function o(t){if(r._subscribed){var e=r.find(t.id);e?e.merge(t):(e=new s(r,t),r.models.push(e),r.commit(),e.emit("post",e),r.emit("post",e))}}this._options={},Object.deepExtend(this._options,n||{});var r=this,c="cmd_"+e;if(/[^a-zA-Z0-9-_\.]/g.test(e))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this.models=[],this._socket=[],this._events={},this._subscribed=!1;var u=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+e,{multiplex:!1});u.path=e,u.on("post",o),u.on("sync",function(t){if(r._subscribed){t.forEach(function(t){o(t)});r.emit("sync",r.models)}}),u.on("put",function(t){if(r._subscribed){var e=r.find(t.id);e?(Object.deepExtend(e,t),r.commit(),e.emit("merge",e),r.emit("merge",e)):o(t)}}),u.on("delete",function(t){if(r._subscribed){var e=r.find(t.id);e&&(Object.deepExtend(e,t),r.commit(),e.emit("merge",e),r.emit("merge",e));var i=r.models.indexOf(e);i>-1&&(r.commit(),e.emit("delete",e),r.emit("delete",e))}}),u.on("clear",function(){i.localStorage.setItem(c,"[]"),r.models.splice(0,r.models.length),r.emit("clear")}),u.on("broadcast",function(t){r.emit("broadcast",t.payload)}),u.on("reconnect",function(){console.log("reconnected"),r._subscribed&&r.subscribe(r._options)});var a=i.localStorage.getItem(c);a&&(this.models=JSON.parse(a).map(function(t){return new s(r,t)}),this.emit("load",this.models)),this.commit=function(){var t=this.models.map(function(t){return t.get()});i.localStorage.setItem(c,JSON.stringify(t))}};r.prototype=Object.create(o.prototype),r.prototype.subscribe=function(t){return this._options=t||{},this._socket.emit("subscribe",this._options),this.emit("subscribed"),this._subscribed=!0,this.sync(),this},r.prototype.unsubscribe=function(){return this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},r.prototype.sync=function(t){var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return this._socket.emit("sync",e),this},r.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},r.prototype.post=function(t){var e=new s(this);return e.post(t),this},r.prototype.create=function(t){return this.post({attributes:t}),this},r.prototype.put=function(t,e){var i=this.find(t);return i&&i.put(t,e),this},r.prototype["delete"]=function(t){var e=this.find(t);return e&&e["delete"](),this},r.prototype.clear=function(){this._socket.emit("clear")},r.prototype.broadcast=function(t){return this._socket.emit("broadcast",{payload:t}),this},r.prototype.close=function(t){return this._socket.close("close"),this},t.Model=s,t.Endpoint=r,t.Utils=i});