!function(t,e){"use strict";"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){"use strict";function e(){this._events={}}var n,i={};if("object"==typeof t&&"undefined"!=typeof module){var o=require("node-localstorage").LocalStorage;n=new o("./scratch")}else n=window.localStorage;!function(t){function e(t){return"function"==typeof t}function n(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(t){return t instanceof Date?t.getTime():t instanceof Array?t.map(i):t}function o(t,e){return t.get?t.get(e):t[e]}function r(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var r=0,s=i.length;s>r;r++)if(t(e,o(i,r)))return!0;return!1}}function s(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var r=0,s=i.length;s>r;r++)if(!t(e,o(i,r)))return!1;return!0}}function c(t,e){return t.v(t.a,e)}function u(t,e){for(var n=0;n<t.length;n++)if(c(e,o(t,n)))return n;return-1}function f(t,e){return{a:t,v:e}}function p(t,e){var n=[];return d(e,t.k,0,n),1===n.length?c(t.nv,n[0]):!!~u(n,t.nv)}function d(t,e,i,r){if(i===e.length||void 0==t)return void r.push(t);var s=o(e,i);if(n(t)&&isNaN(Number(s)))for(var c=0,u=t.length;u>c;c++)d(o(t,c),e,i,r);else d(o(t,s),e,i+1,r)}function h(t,e){return{a:{k:t,nv:e},v:p}}function a(t){t=i(t),(!t||"Object"!==t.constructor.toString()&&"functionObject(){[nativecode]}"!==t.constructor.toString().replace(/\n/g,"").replace(/ /g,""))&&(t={$eq:t});var e=[];for(var n in t){var o=t[n];if("$options"!==n)if(_[n])v[n]&&(o=v[n](o,t)),e.push(f(i(o),_[n]));else{if(36===n.charCodeAt(0))throw new Error("Unknown operation "+n);e.push(h(n.split("."),a(o)))}}return 1===e.length?e[0]:f(e,_.$and)}function l(t,e){var n=a(t);return e&&(n={a:n,v:function(t,n){return c(t,e(n))}}),n}function m(t,n,i){function o(t){return c(r,t)}e(n)&&(i=n,n=void 0);var r=l(t,i);return n?n.filter(o):o}var _={$eq:r(function(t,e){return t(e)}),$ne:s(function(t,e){return!t(e)}),$or:function(t,e){for(var n=0,i=t.length;i>n;n++)if(c(o(t,n),e))return!0;return!1},$gt:r(function(t,e){return m.compare(i(e),t)>0}),$gte:r(function(t,e){return m.compare(i(e),t)>=0}),$lt:r(function(t,e){return m.compare(i(e),t)<0}),$lte:r(function(t,e){return m.compare(i(e),t)<=0}),$mod:r(function(t,e){return e%t[0]==t[1]}),$in:function(t,e){if(!(e instanceof Array))return!!~t.indexOf(i(e));for(var n=e.length;n--;)if(~t.indexOf(i(o(e,n))))return!0;return!1},$nin:function(t,e){return!_.$in(t,e)},$not:function(t,e){return!c(t,e)},$type:function(t,e){return void 0!=e?e instanceof t||e.constructor==t:!1},$all:function(t,e){e||(e=[]);for(var n=t.length;n--;)if(!~i(e).indexOf(o(t,n)))return!1;return!0},$size:function(t,e){return e?t===e.length:!1},$nor:function(t,e){for(var n=0,i=t.length;i>n;n++)if(c(o(t,n),e))return!1;return!0},$and:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!c(o(t,n),e))return!1;return!0},$regex:r(function(t,e){return"string"==typeof e&&t.test(e)}),$where:function(t,e){return t.call(e,e)},$elemMatch:function(t,e){return n(e)?!!~u(e,t):c(t,e)},$exists:function(t,e){return void 0!=e===t}},v={$eq:function(t){return t instanceof RegExp?function(e){return"string"==typeof e&&t.test(e)}:t instanceof Function?t:n(t)&&!t.length?function(t){return n(t)&&!t.length}:null===t?function(t){return null===t||void 0===t}:function(e){return 0===m.compare(i(e),t)}},$ne:function(t){return v.$eq(t)},$and:function(t){return t.map(a)},$or:function(t){return t.map(a)},$nor:function(t){return t.map(a)},$not:function(t){return a(t)},$regex:function(t,e){return new RegExp(t,e.$options)},$where:function(t){return t},$elemMatch:function(t){return a(t)},$exists:function(t){return!!t}};m.use=function(t){if(e(t))return t(m);for(var n in t)36===n.charCodeAt(0)&&(_[n]=t[n])},m.indexOf=function(t,e,n){return u(e,l(t,n))},m.compare=function(t,e){if(t===e)return 0;if(typeof t==typeof e){if(t>e)return 1;if(e>t)return-1}},t.sift=m}(i),function(t){function e(t){var e,n=[],i={};for(e in t)n.push([e,t[e]]);n.sort(function(t,e){return e[1]-t[1]});for(e in n)i[n[e][0]]=n[e][1];return i}function i(t){var e,n=t[t.length-1],o=t.substring(0,t.length-1);return"undefined"==typeof n?e="a":"z"===n?e="A":"Z"===n?(e="a",o=""!==o?i(o):"a"):e=String.fromCharCode(n.charCodeAt(0)+1),n=e,o+n}function o(t){var n,o,r={},s="",c=t.match(u);for(n in c)c[n].length>s.length+2&&("undefined"!=typeof r[c[n]]?r[c[n]]+=1:r[c[n]]=0);o=e(r);for(n in o)s=i(s),o[n]=f+s+f;return o}function r(t,e){var n,i;for(n in e)i=new RegExp(n,"g"),t=t.replace(i,e[n]);return t}function s(t,e){var n,i;for(n in e)i=new RegExp(e[n],"g"),t=t.replace(i,n);return t}function c(){this.setItem=function(t,e,i){var s,c,u;return"undefined"!=typeof i&&"no-beautify"===i||(c=JSON.parse(e),e=JSON.stringify(c)),u=o(e),s=r(e,u),"undefined"!=typeof i&&"local-dict"===i?p[t]=u:n.setItem(t,s),"undefined"==typeof p[t]&&n.setItem("d_"+t,JSON.stringify(u)),s},this.getItem=function(t){var e,i;return e=n.getItem(t),i="undefined"==typeof p[t]?JSON.parse(n.getItem("d_"+t)):p[t],s(e,i)},this.getDict=function(t){var e;return e="undefined"==typeof p[t]?JSON.parse(n.getItem("d_"+t)):p[t]},this.setDict=function(t,e,i){"undefined"==typeof i?n.setItem("d_"+t,e):p[t]=e}}var u=/\"[a-zA-Z0-9]*\":/g,f="Â£",p={};t.JJLC=new c}(i),i.localStorage=i.JJLC,function(t){for(var e=[],n=0;15>=n;n++)e[n]=n.toString(16);var i={v4:function(){for(var t="",n=1;36>=n;n++)t+=9===n||14===n||19===n||24===n?"-":15===n?4:20===n?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=i}(i),Object.deepExtend=function f(t,e){for(var n in e)e[n]&&e[n].constructor&&e[n].constructor===Object?(t[n]=t[n]||{},f(t[n],e[n])):t[n]=e[n];return t},e.prototype={on:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]),n._events[t].push(e)}),this},off:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){var e=n._events[t];e&&(n._events[t]=n._events[t].filter(function(t){return t!==t}))}),this},once:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]),e._callOnce=!0,n._events[t].push(e)}),this},emit:function(t,e,n){var i=this;n=n||this;var o=this._events[t]||(this._events[t]=[]);return o.forEach(function(o){return o._callOnce?(delete o._callOnce,o.call(n,e),i.off(t,o),i):void o.call(n,e)}),this}};var r=function(t){var e={};for(var n in t)t.hasOwnProperty(n)&&-1==["$$hashKey","_endpoint","_events"].indexOf(n)&&(e[n]=t[n]);return e},s=function(t,e){e=e||{},Object.deepExtend(this,e),this.id=this.id||i.uuid.v4(),this.meta=this.meta||{},this._events={},this._endpoint=t};s.prototype=Object.create(e.prototype),s.prototype.get=function(){return r(this)},s.prototype.post=function(t){var e=this;t&&this._endpoint._socket.once("receipt:post",t);var n={meta:{synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null}};return Object.deepExtend(this,n),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.once("denied:post:"+this.id,function(){e._endpoint._socket.off("receipt:post",t);var n=e._endpoint.models.indexOf(e);n>-1&&(e._endpoint.models.splice(n,1),e._endpoint.commit(),e._endpoint.emit("post",e.id))}),this._endpoint._socket.emit("post",this.get()),this},s.prototype.put=function(t,e){var n=this;return e&&this._endpoint._socket.once("receipt:put",e),Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.once("denied:put:"+this.id,function(t){n._endpoint._socket.off("receipt:put",e),Object.deepExtend(n,t),n._endpoint.commit(),n.emit("put"),n._endpoint.emit("put")}),this._endpoint._socket.emit("put",this.get()),this},s.prototype["delete"]=function(t){var e=this;t&&this._endpoint._socket.once("receipt:delete",t);for(var n in this)this.hasOwnProperty(n)&&-1==["meta","id","_endpoint","_events"].indexOf(n)&&delete this[n];return this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.once("denied:delete:"+this.id,function(n){e._endpoint._socket.off("receipt:delete",t),Object.deepExtend(e,n),e._endpoint.commit(),e.emit("delete"),e._endpoint.emit("delete")}),this._endpoint._socket.emit("delete",this.id),this},s.prototype.merge=function(t){return JSON.stringify(r(this))!=JSON.stringify(t)&&(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this)),this};var c=function(t,e,n){function o(t,e){m._subscribed&&(t.forEach(function(t){r(t)}),m.emit("sync",m.models),e&&e())}function r(t,e){if(m._subscribed){var n=m.find(t.id);n?(n.merge(t),n.emit("merge",n),m.emit("merge",n)):(n=new m._Model(m,t),m.models.push(n),m.commit()),n.emit("post",n),m.emit("post",n),e&&e(n)}}function c(t,e){if(m._subscribed){var n=m.find(t.id);n?(Object.deepExtend(n,t),m.commit(),n.emit("merge",n),m.emit("merge",n)):(n=new m._Model(m,t),m.models.push(n),m.commit()),n.emit("put"),e&&e(n)}}function u(t,e){if(m._subscribed){var n=m.find(t.id);if(n){for(var i in n)n.hasOwnProperty(i)&&-1==["id","meta","$$hashKey","_endpoint","_events"].indexOf(i)&&delete n[i];Object.deepExtend(n.meta,t.meta),m.commit(),n.emit("merge",n),m.emit("merge",n),e&&e(n)}}}function f(t){i.localStorage.setItem(_,"[]"),m.models.splice(0,m.models.length),m.emit("clear"),t&&t()}function p(t,e){m.emit("listen",t),e&&e(t)}function d(t,e){m.emit("unlisten",t),e&&e(t)}function h(t,e){m.emit("broadcast",t),m.emit("broadcast:"+t.channel,t.payload),e&&e(t)}function a(){m._subscribed&&m.subscribe(m._options)}function l(t){console.error(t)}this._options={},Object.deepExtend(this._options,n||{});var m=this,_=this._key="cmd_"+e;if(/[^a-zA-Z0-9-_\.]/g.test(e))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this._Model=this._options.model||s,this.models=[],this._socket=[],this._events={},this._filter=null,this._subscribed=!1;var v=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+e,{multiplex:!1});v.path=e,v.on("sync",o),v.on("post",r),v.on("put",c),v.on("delete",u),v.on("clear",f),v.on("broadcast",h),v.on("reconnect",a),v.on("cmderror",l),v.on("sync",function(t){o(t,function(t){m.emit("receipt:sync")})}),v.on("receipt:post",function(t){r(t,function(t){t.emit("receipt:post",t)})}),v.on("receipt:put",function(t){c(t,function(t){t.emit("receipt:put",t)})}),v.on("receipt:delete",function(t){u(t,function(t){t.emit("receipt:delete",t)})}),v.on("receipt:clear",function(){f(function(){m.emit("receipt:clear")})}),v.on("receipt:listen",function(t){p(t,function(t){m.emit("receipt:listen:"+t,t)})}),v.on("receipt:unlisten",function(t){d(t,function(t){m.emit("receipt:unlisten:"+t,t)})}),v.on("receipt:broadcast",function(t){h(t,function(t){m.emit("receipt:broadcast",t)})})};c.prototype=Object.create(e.prototype),c.prototype.load=function(t){var e=this,n=i.localStorage.getItem(this._key);if(t&&this.once("load",t,this),n){var o=JSON.parse(n).map(function(t){return new e._Model(e,t)});this._filter&&(o=i.sift(this._filter,o)),o.unshift(0),o.unshift(this.models.length),this.models.splice.apply(this.models,o)}this.emit("load",this.models)},c.prototype.commit=function(t){t&&this.once("commit",t);var e=this.models.map(function(t){return t.get()});i.localStorage.setItem(this._key,JSON.stringify(e)),this.emit("commit")},c.prototype.subscribe=function(t,e){function n(){i._options=t||{},i._filter=i._options.filter,i._socket.emit("subscribe",i._options),i.emit("subscribed"),i._subscribed=!0,i.sync(e)}"function"==typeof t&&(e=t,t={});var i=this;return this._subscribed?this.unsubscribe(n):n(),this},c.prototype.unsubscribe=function(t){return t&&this._socket.once("unsubscribe",t),this.models.splice(0,this.models.length),this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},c.prototype.sync=function(t){this.load();var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return t&&this.once("receipt:sync",t),this._socket.emit("sync",e),this},c.prototype.post=c.prototype.create=function(t,e){var n=new this._Model(this,t);return e&&n.once("receipt:post",e),n.post(),this},c.prototype.put=function(t,e,n){var i=this.find(t);return i&&(n&&i.once("receipt:put",n),i.put(e)),this},c.prototype["delete"]=function(t,e){var n=this.find(t);return n&&(e&&n.once("receipt:delete",e),n["delete"]()),this},c.prototype.clear=function(t){return t&&this._socket.once("receipt:clear",t),this._socket.emit("clear"),this},c.prototype.listen=function(t,e){return e&&this.once("receipt:listen:"+t,e),this._socket.emit("listen",t),this},c.prototype.unlisten=function(t,e){return e&&this.once("receipt:unlisten:"+t,e),this._socket.emit("unlisten",t),this},c.prototype.broadcast=function(t,e,n){return n&&this.once("receipt:broadcast",n),this._socket.emit("broadcast",{channel:t,payload:e}),this},c.prototype.close=function(t){return t&&this._socket.once("close",t),this._socket.close("close"),this},c.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},c.prototype.where=function(t){return new u(this,t)};var u=function(t,e){this.models=[],this._filter=e,this._endpoint=t,this._events={};var n=this;this._endpoint.on("subscribed",function(){n.run(),n.emit("subscribed")}),this._endpoint.on("unsubscribed",function(){n.run(),n.emit("unsubscribed")}),this._endpoint.on("sync",function(t){n.run(),n.emit("sync",t)}),this._endpoint.on("post",function(t){n.run(),n.emit("post",t)}),this._endpoint.on("put",function(t){n.run(),n.emit("put",t)}),this._endpoint.on("delete",function(t){n.run(),n.emit("put",t)}),this._endpoint.on("clear",function(){n.run(),n.emit("clear")}),this._endpoint.on("merge",function(){n.run(),n.emit("merge")}),this.run.call(n)};u.prototype=Object.create(e.prototype),u.prototype.run=function(){return this.models=this._endpoint.models.filter(this._filter),this},u.prototype.put=function(t){return this.models.forEach(function(e){e.put(t)}),this},u.prototype["delete"]=function(){return this.models.forEach(function(t){t["delete"]()}),this},t.Model=s,t.Query=u,t.Endpoint=c,t.Utils=i});