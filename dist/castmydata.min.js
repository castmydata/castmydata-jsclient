!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){var e={};!function(t){"use strict";function e(t){var e,i=[],n={};for(e in t)i.push([e,t[e]]);i.sort(function(t,e){return e[1]-t[1]});for(e in i)n[i[e][0]]=i[e][1];return n}function i(t){var e,n=t[t.length-1],o=t.substring(0,t.length-1);return"undefined"==typeof n?e="a":"z"===n?e="A":"Z"===n?(e="a",o=""!==o?i(o):"a"):e=String.fromCharCode(n.charCodeAt(0)+1),n=e,o+n}function n(t){var n,o,s={},r="",a=t.match(c);for(n in a)a[n].length>r.length+2&&("undefined"!=typeof s[a[n]]?s[a[n]]+=1:s[a[n]]=0);o=e(s);for(n in o)r=i(r),o[n]=u+r+u;return o}function o(t,e){var i,n;for(i in e)n=new RegExp(i,"g"),t=t.replace(n,e[i]);return t}function s(t,e){var i,n;for(i in e)n=new RegExp(e[i],"g"),t=t.replace(n,i);return t}function r(){this.setItem=function(t,e,i){var s,r,c;return"undefined"!=typeof i&&"no-beautify"===i||(r=JSON.parse(e),e=JSON.stringify(r)),c=n(e),s=o(e,c),"undefined"!=typeof i&&"local-dict"===i?a[t]=c:localStorage.setItem(t,s),"undefined"==typeof a[t]&&localStorage.setItem("d_"+t,JSON.stringify(c)),s},this.getItem=function(t){var e,i;return e=localStorage.getItem(t),i="undefined"==typeof a[t]?JSON.parse(localStorage.getItem("d_"+t)):a[t],s(e,i)},this.getDict=function(t){var e;return e="undefined"==typeof a[t]?JSON.parse(localStorage.getItem("d_"+t)):a[t]},this.setDict=function(t,e,i){"undefined"==typeof i?localStorage.setItem("d_"+t,e):a[t]=e}}var c=/\"[a-zA-Z0-9]*\":/g,u="Â£",a={};t.JJLC=new r}(e),e.localStorage=e.JJLC,function(t){for(var e=[],i=0;15>=i;i++)e[i]=i.toString(16);var n={v4:function(){for(var t="",i=1;36>=i;i++)t+=9===i||14===i||19===i||24===i?"-":15===i?4:20===i?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=n}(e);var i=function(){function t(t){this.head=new e,this.tail=new e(this.head),this.head.next=this.tail,this.linkConstructor=t,this.reg={}}function e(t,e,n){this.prev=t,this.next=e,this.fn=n||i}function i(){}function n(){this._events={}}var o=0;return t.prototype={insert:function(t){var i=new e(this.tail.prev,this.tail,t);return i.next.prev=i.prev.next=i,i},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev}},e.prototype.run=function(t){this.fn(t),this.next&&this.next.run(t)},n.prototype={on:function(e,i){var n=this;return e.split(/\W+/g).forEach(function(e){var s=n._events[e]||(n._events[e]=new t),r=i._eev||(i._eev=++o);s.reg[r]||(s.reg[r]=s.insert(i))}),this},off:function(t,e){var i=this;return t.split(/\W+/g).forEach(function(t){var n=i._events[t],o=n.reg[e._eev];n.reg[e._eev]=void 0,n&&o&&n.remove(o)}),this},emit:function(t,e){var i=this._events[t];return i&&i.head.run(e),this}},n}();Object.deepExtend=function(t,e){for(var i in e)e[i]&&e[i].constructor&&e[i].constructor===Object?(t[i]=t[i]||{},arguments.callee(t[i],e[i])):t[i]=e[i];return t};var n=function(t,i){i=i||{},this.id=i.id||e.uuid.v4(),this.attributes=i.attributes||{},this.meta=i.meta||{},this._events={},this._endpoint=t};n.prototype=Object.create(i.prototype),n.prototype.get=function(){return JSON.parse(JSON.stringify({id:this.id,attributes:this.attributes,meta:this.meta}))},n.prototype.post=function(t){t.meta={synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null},Object.deepExtend(this,t),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.emit("post",this.get())},n.prototype.put=function(t){Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.emit("put",this.get())},n.prototype["delete"]=function(){this.attributes={},this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.emit("delete",this.id)},n.prototype.merge=function(t){return JSON.stringify(this.attributes)!=JSON.stringify(t.attributes)||JSON.stringify(this.meta)!=JSON.stringify(t.meta)?(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this),!0):!1};var o=function(t,i,o){function s(t){if(r._subscribed){var e=r.find(t.id);e?e.merge(t):(e=new n(r,t),r.models.push(e),r.commit(),e.emit("post",e),r.emit("post",e))}}this._options={},Object.deepExtend(this._options,o||{});var r=this,c="cmd_"+i;if(/[^a-zA-Z0-9-_\.]/g.test(i))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this.models=[],this._socket=[],this._events={},this._subscribed=!1;var u=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+i,{multiplex:!1});u.path=i,u.on("post",s),u.on("sync",function(t){if(r._subscribed){t.forEach(function(t){s(t)});r.emit("sync",r.models)}}),u.on("put",function(t){if(r._subscribed){var e=r.find(t.id);e?(Object.deepExtend(e,t),r.commit(),e.emit("merge",e),r.emit("merge",e)):s(t)}}),u.on("delete",function(t){if(r._subscribed){var e=r.find(t.id);e&&(Object.deepExtend(e,t),r.commit(),e.emit("merge",e),r.emit("merge",e));var i=r.models.indexOf(e);i>-1&&(r.commit(),e.emit("delete",e),r.emit("delete",e))}}),u.on("clear",function(){e.localStorage.setItem(c,"[]"),r.models.splice(0,r.models.length),r.emit("clear")}),u.on("broadcast",function(t){r.emit("broadcast",t.payload)}),u.on("reconnect",function(){console.log("reconnected"),r._subscribed&&r.subscribe(r._options)});var a=e.localStorage.getItem(c);a&&(this.models=JSON.parse(a).map(function(t){return new n(r,t)}),this.emit("load",this.models)),this.commit=function(){var t=this.models.map(function(t){return t.get()});e.localStorage.setItem(c,JSON.stringify(t))}};o.prototype=Object.create(i.prototype),o.prototype.subscribe=function(t){return this._options=t||{},this._socket.emit("subscribe",this._options),this.emit("subscribed"),this._subscribed=!0,this.sync(),this},o.prototype.unsubscribe=function(){return this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},o.prototype.sync=function(t){var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return this._socket.emit("sync",e),this},o.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},o.prototype.post=function(t){var e=new n(this);return e.post(t),this},o.prototype.create=function(t){return this.post({attributes:t}),this},o.prototype.put=function(t,e){var i=this.find(t);return i&&i.put(t,e),this},o.prototype["delete"]=function(t){var e=this.find(t);return e&&e["delete"](),this},o.prototype.clear=function(){this._socket.emit("clear")},o.prototype.broadcast=function(t){return this._socket.emit("broadcast",{payload:t}),this},t.Model=n,t.Endpoint=o,t.Utils=e});