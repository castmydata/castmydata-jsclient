!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){var e,i={};if("object"==typeof t&&"undefined"!=typeof module){var n=require("node-localstorage").LocalStorage;e=new n("./scratch")}else e=window.localStorage;!function(t){"use strict";function i(t){var e,i=[],n={};for(e in t)i.push([e,t[e]]);i.sort(function(t,e){return e[1]-t[1]});for(e in i)n[i[e][0]]=i[e][1];return n}function n(t){var e,i=t[t.length-1],o=t.substring(0,t.length-1);return"undefined"==typeof i?e="a":"z"===i?e="A":"Z"===i?(e="a",o=""!==o?n(o):"a"):e=String.fromCharCode(i.charCodeAt(0)+1),i=e,o+i}function o(t){var e,o,r={},s="",c=t.match(u);for(e in c)c[e].length>s.length+2&&("undefined"!=typeof r[c[e]]?r[c[e]]+=1:r[c[e]]=0);o=i(r);for(e in o)s=n(s),o[e]=p+s+p;return o}function r(t,e){var i,n;for(i in e)n=new RegExp(i,"g"),t=t.replace(n,e[i]);return t}function s(t,e){var i,n;for(i in e)n=new RegExp(e[i],"g"),t=t.replace(n,i);return t}function c(){this.setItem=function(t,i,n){var s,c,u;return"undefined"!=typeof n&&"no-beautify"===n||(c=JSON.parse(i),i=JSON.stringify(c)),u=o(i),s=r(i,u),"undefined"!=typeof n&&"local-dict"===n?a[t]=u:e.setItem(t,s),"undefined"==typeof a[t]&&e.setItem("d_"+t,JSON.stringify(u)),s},this.getItem=function(t){var i,n;return i=e.getItem(t),n="undefined"==typeof a[t]?JSON.parse(e.getItem("d_"+t)):a[t],s(i,n)},this.getDict=function(t){var i;return i="undefined"==typeof a[t]?JSON.parse(e.getItem("d_"+t)):a[t]},this.setDict=function(t,i,n){"undefined"==typeof n?e.setItem("d_"+t,i):a[t]=i}}var u=/\"[a-zA-Z0-9]*\":/g,p="Â£",a={};t.JJLC=new c}(i),i.localStorage=i.JJLC,function(t){for(var e=[],i=0;15>=i;i++)e[i]=i.toString(16);var n={v4:function(){for(var t="",i=1;36>=i;i++)t+=9===i||14===i||19===i||24===i?"-":15===i?4:20===i?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=n}(i);var o=function(){function t(t){this.head=new e,this.tail=new e(this.head),this.head.next=this.tail,this.linkConstructor=t,this.reg={}}function e(t,e,n){this.prev=t,this.next=e,this.fn=n||i}function i(){}function n(){this._events={}}var o=0;return t.prototype={insert:function(t){var i=new e(this.tail.prev,this.tail,t);return i.next.prev=i.prev.next=i,i},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev}},e.prototype.run=function(t){this.fn(t),this.next&&this.next.run(t)},n.prototype={on:function(e,i){var n=this;return e.split(/\W+/g).forEach(function(e){var r=n._events[e]||(n._events[e]=new t),s=i._eev||(i._eev=++o);r.reg[s]||(r.reg[s]=r.insert(i))}),this},off:function(t,e){var i=this;return t.split(/\W+/g).forEach(function(t){var n=i._events[t],o=n.reg[e._eev];n.reg[e._eev]=void 0,n&&o&&n.remove(o)}),this},emit:function(t,e){var i=this._events[t];return i&&i.head.run(e),this}},n}();Object.deepExtend=function(t,e){for(var i in e)e[i]&&e[i].constructor&&e[i].constructor===Object?(t[i]=t[i]||{},arguments.callee(t[i],e[i])):t[i]=e[i];return t};var r=function(t,e){e=e||{},this.id=e.id||i.uuid.v4(),this.attributes=e.attributes||{},this.meta=e.meta||{},this._events={},this._endpoint=t};r.prototype=Object.create(o.prototype),r.prototype.get=function(){return JSON.parse(JSON.stringify({id:this.id,attributes:this.attributes,meta:this.meta}))},r.prototype.post=function(t){t.meta={synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null},Object.deepExtend(this,t),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.emit("post",this.get())},r.prototype.put=function(t){Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.emit("put",this.get())},r.prototype["delete"]=function(){this.attributes={},this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.emit("delete",this.id)},r.prototype.merge=function(t){return JSON.stringify(this.attributes)!=JSON.stringify(t.attributes)||JSON.stringify(this.meta)!=JSON.stringify(t.meta)?(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this),!0):!1};var s=function(t,e,n){function o(t){if(s._subscribed){var e=s.find(t.id);e?e.merge(t):(e=new r(s,t),s.models.push(e),s.commit(),e.emit("post",e),s.emit("post",e))}}this._options={},Object.deepExtend(this._options,n||{});var s=this,c="cmd_"+e;if(/[^a-zA-Z0-9-_\.]/g.test(e))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this.models=[],this._socket=[],this._events={},this._subscribed=!1;var u=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+e,{multiplex:!1});u.path=e,u.on("post",o),u.on("sync",function(t){if(s._subscribed){t.forEach(function(t){o(t)});s.emit("sync",s.models)}}),u.on("put",function(t){if(s._subscribed){var e=s.find(t.id);e?(Object.deepExtend(e,t),s.commit(),e.emit("merge",e),s.emit("merge",e)):o(t)}}),u.on("delete",function(t){if(s._subscribed){var e=s.find(t.id);e&&(Object.deepExtend(e,t),s.commit(),e.emit("merge",e),s.emit("merge",e))}}),u.on("clear",function(){i.localStorage.setItem(c,"[]"),s.models.splice(0,s.models.length),s.emit("clear")}),u.on("broadcast",function(t){s.emit("broadcast",t.payload)}),u.on("reconnect",function(){s._subscribed&&s.subscribe(s._options)});var p=i.localStorage.getItem(c);p&&(this.models=JSON.parse(p).map(function(t){return new r(s,t)}),this.emit("load",this.models)),this.commit=function(){var t=this.models.map(function(t){return t.get()});i.localStorage.setItem(c,JSON.stringify(t))}};s.prototype=Object.create(o.prototype),s.prototype.subscribe=function(t){return this._options=t||{},this._socket.emit("subscribe",this._options),this.emit("subscribed"),this._subscribed=!0,this.sync(),this},s.prototype.unsubscribe=function(){return this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},s.prototype.sync=function(t){var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return this._socket.emit("sync",e),this},s.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},s.prototype.where=function(t){return new c(this,t)},s.prototype.post=function(t){var e=new r(this);return e.post(t),this},s.prototype.create=function(t){return this.post({attributes:t}),this},s.prototype.put=function(t,e){var i=this.find(t);return i&&i.put(e),this},s.prototype["delete"]=function(t){var e=this.find(t);return e&&e["delete"](),this},s.prototype.clear=function(){return this._socket.emit("clear"),this},s.prototype.broadcast=function(t){return this._socket.emit("broadcast",{payload:t}),this},s.prototype.close=function(){return this._socket.close("close"),this};var c=function(t,e){this.models=[],this._filter=e,this._endpoint=t,this._events={};var i=this;this._endpoint.on("subscribed",function(){i.run.call(i),i.emit("subscribed")}),this._endpoint.on("unsubscribed",function(){i.run.call(i),i.emit("unsubscribed")}),this._endpoint.on("sync",function(){i.run.call(i);var t=Array.prototype.slice.call(arguments);t.unshift("sync"),i.emit.apply(i,t)}),this._endpoint.on("post",function(){i.run.call(i);var t=Array.prototype.slice.call(arguments);t.unshift("post"),i.emit.apply(i,t)}),this._endpoint.on("put",function(){i.run.call(i);var t=Array.prototype.slice.call(arguments);t.unshift("put"),i.emit.apply(i,t)}),this._endpoint.on("delete",function(){i.run.call(i);var t=Array.prototype.slice.call(arguments);t.unshift("delete"),i.emit.apply(i,t)}),this._endpoint.on("clear",function(){i.run.call(i),i.emit("clear")}),this._endpoint.on("merge",function(){i.run.call(i),i.emit("merge")}),this.run.call(i)};c.prototype=Object.create(o.prototype),c.prototype.run=function(){return this.models=this._endpoint.models.filter(this._filter),this},c.prototype.put=function(t){return this.models.forEach(function(e){e.put(t)}),this},c.prototype["delete"]=function(){return this.models.forEach(function(t){t["delete"]()}),this},t.Model=r,t.Query=c,t.Endpoint=s,t.Utils=i});