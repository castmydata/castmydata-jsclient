!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){function e(){this._events={}}var n,i={};if("object"==typeof t&&"undefined"!=typeof module){var r=require("node-localstorage").LocalStorage;n=new r("./scratch")}else n=window.localStorage;!function(t){"use strict";function e(t){return"function"==typeof t}function n(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(t){return t instanceof Date?t.getTime():t instanceof Array?t.map(i):t}function r(t,e){return t.get?t.get(e):t[e]}function o(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var o=0,s=i.length;s>o;o++)if(t(e,r(i,o)))return!0;return!1}}function s(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var o=0,s=i.length;s>o;o++)if(!t(e,r(i,o)))return!1;return!0}}function u(t,e){return t.v(t.a,e)}function c(t,e){for(var n=0;n<t.length;n++)if(u(e,r(t,n)))return n;return-1}function f(t,e){return{a:t,v:e}}function p(t,e){var n=[];return a(e,t.k,0,n),1===n.length?u(t.nv,n[0]):!!~c(n,t.nv)}function a(t,e,i,o){if(i===e.length||void 0==t)return void o.push(t);var s=r(e,i);if(n(t)&&isNaN(Number(s)))for(var u=0,c=t.length;c>u;u++)a(r(t,u),e,i,o);else a(r(t,s),e,i+1,o)}function h(t,e){return{a:{k:t,nv:e},v:p}}function d(t){t=i(t),(!t||"Object"!==t.constructor.toString()&&"functionObject(){[nativecode]}"!==t.constructor.toString().replace(/\n/g,"").replace(/ /g,""))&&(t={$eq:t});var e=[];for(var n in t){var r=t[n];if("$options"!==n)if(g[n])v[n]&&(r=v[n](r,t)),e.push(f(i(r),g[n]));else{if(36===n.charCodeAt(0))throw new Error("Unknown operation "+n);e.push(h(n.split("."),d(r)))}}return 1===e.length?e[0]:f(e,g.$and)}function l(t,e){var n=d(t);return e&&(n={a:n,v:function(t,n){return u(t,e(n))}}),n}function m(t,n,i){function r(t){return u(o,t)}e(n)&&(i=n,n=void 0);var o=l(t,i);return n?n.filter(r):r}var g={$eq:o(function(t,e){return t(e)}),$ne:s(function(t,e){return!t(e)}),$or:function(t,e){for(var n=0,i=t.length;i>n;n++)if(u(r(t,n),e))return!0;return!1},$gt:o(function(t,e){return m.compare(i(e),t)>0}),$gte:o(function(t,e){return m.compare(i(e),t)>=0}),$lt:o(function(t,e){return m.compare(i(e),t)<0}),$lte:o(function(t,e){return m.compare(i(e),t)<=0}),$mod:o(function(t,e){return e%t[0]==t[1]}),$in:function(t,e){if(!(e instanceof Array))return!!~t.indexOf(i(e));for(var n=e.length;n--;)if(~t.indexOf(i(r(e,n))))return!0;return!1},$nin:function(t,e){return!g.$in(t,e)},$not:function(t,e){return!u(t,e)},$type:function(t,e){return void 0!=e?e instanceof t||e.constructor==t:!1},$all:function(t,e){e||(e=[]);for(var n=t.length;n--;)if(!~i(e).indexOf(r(t,n)))return!1;return!0},$size:function(t,e){return e?t===e.length:!1},$nor:function(t,e){for(var n=0,i=t.length;i>n;n++)if(u(r(t,n),e))return!1;return!0},$and:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!u(r(t,n),e))return!1;return!0},$regex:o(function(t,e){return"string"==typeof e&&t.test(e)}),$where:function(t,e){return t.call(e,e)},$elemMatch:function(t,e){return n(e)?!!~c(e,t):u(t,e)},$exists:function(t,e){return void 0!=e===t}},v={$eq:function(t){return t instanceof RegExp?function(e){return"string"==typeof e&&t.test(e)}:t instanceof Function?t:n(t)&&!t.length?function(t){return n(t)&&!t.length}:null===t?function(t){return null==t}:function(e){return 0===m.compare(i(e),t)}},$ne:function(t){return v.$eq(t)},$and:function(t){return t.map(d)},$or:function(t){return t.map(d)},$nor:function(t){return t.map(d)},$not:function(t){return d(t)},$regex:function(t,e){return new RegExp(t,e.$options)},$where:function(t){return"string"==typeof t?new Function("obj","return "+t):t},$elemMatch:function(t){return d(t)},$exists:function(t){return!!t}};m.use=function(t){if(e(t))return t(m);for(var n in t)36===n.charCodeAt(0)&&(g[n]=t[n])},m.indexOf=function(t,e,n){return c(e,l(t,n))},m.compare=function(t,e){if(t===e)return 0;if(typeof t==typeof e){if(t>e)return 1;if(e>t)return-1}},t.sift=m}(i),function(t){"use strict";function e(t){var e,n=[],i={};for(e in t)n.push([e,t[e]]);n.sort(function(t,e){return e[1]-t[1]});for(e in n)i[n[e][0]]=n[e][1];return i}function i(t){var e,n=t[t.length-1],r=t.substring(0,t.length-1);return"undefined"==typeof n?e="a":"z"===n?e="A":"Z"===n?(e="a",r=""!==r?i(r):"a"):e=String.fromCharCode(n.charCodeAt(0)+1),n=e,r+n}function r(t){var n,r,o={},s="",u=t.match(c);for(n in u)u[n].length>s.length+2&&("undefined"!=typeof o[u[n]]?o[u[n]]+=1:o[u[n]]=0);r=e(o);for(n in r)s=i(s),r[n]=f+s+f;return r}function o(t,e){var n,i;for(n in e)i=new RegExp(n,"g"),t=t.replace(i,e[n]);return t}function s(t,e){var n,i;for(n in e)i=new RegExp(e[n],"g"),t=t.replace(i,n);return t}function u(){this.setItem=function(t,e,i){var s,u,c;return"undefined"!=typeof i&&"no-beautify"===i||(u=JSON.parse(e),e=JSON.stringify(u)),c=r(e),s=o(e,c),"undefined"!=typeof i&&"local-dict"===i?p[t]=c:n.setItem(t,s),"undefined"==typeof p[t]&&n.setItem("d_"+t,JSON.stringify(c)),s},this.getItem=function(t){var e,i;return e=n.getItem(t),i="undefined"==typeof p[t]?JSON.parse(n.getItem("d_"+t)):p[t],s(e,i)},this.getDict=function(t){var e;return e="undefined"==typeof p[t]?JSON.parse(n.getItem("d_"+t)):p[t]},this.setDict=function(t,e,i){"undefined"==typeof i?n.setItem("d_"+t,e):p[t]=e}}var c=/\"[a-zA-Z0-9]*\":/g,f="Â£",p={};t.JJLC=new u}(i),i.localStorage=i.JJLC,function(t){for(var e=[],n=0;15>=n;n++)e[n]=n.toString(16);var i={v4:function(){for(var t="",n=1;36>=n;n++)t+=9===n||14===n||19===n||24===n?"-":15===n?4:20===n?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=i}(i),Object.deepExtend=function(t,e){for(var n in e)e[n]&&e[n].constructor&&e[n].constructor===Object?(t[n]=t[n]||{},arguments.callee(t[n],e[n])):t[n]=e[n];return t},e.prototype={on:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]);n._events[t].push(e)}),this},off:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){var e=n._events[t];e&&(n._events[t]=n._events[t].filter(function(t){return t!==t}))}),this},once:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]);e._callOnce=!0,n._events[t].push(e)}),this},emit:function(t,e,n){var i=this;n=n||this;var r=this._events[t]||(this._events[t]=[]);return r.forEach(function(r){return r._callOnce?(delete r._callOnce,r.call(n,e),i.off(t,r),i):void r.call(n,e)}),this}};var o=function(t,e){e=e||{},this.id=e.id||i.uuid.v4(),this.attributes=e.attributes||{},this.meta=e.meta||{},this._events={},this._endpoint=t};o.prototype=Object.create(e.prototype),o.prototype.get=function(){return JSON.parse(JSON.stringify({id:this.id,attributes:this.attributes,meta:this.meta}))},o.prototype.post=function(t,e){return e&&this._endpoint._socket.once("post",e),t.meta={synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null},Object.deepExtend(this,t),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.emit("post",this.get()),this},o.prototype.put=function(t,e){return Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.emit("put",this.get()),this},o.prototype["delete"]=function(t){return t&&this._endpoint._socket.once("delete",t),this.attributes={},this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.emit("delete",this.id),this},o.prototype.merge=function(t){return JSON.stringify(this.attributes)==JSON.stringify(t.attributes)&&JSON.stringify(this.meta)==JSON.stringify(t.meta)||(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this)),this};var s=function(t,e,n){function r(t,e){if(d._subscribed){t.forEach(function(t){s(t)});d.emit("sync",d.models),e&&e()}}function s(t,e){if(d._subscribed){var n=d.find(t.id);n?(n.merge(t),n.emit("merge",n),d.emit("merge",n)):(n=new o(d,t),d.models.push(n),d.commit()),n.emit("post",n),d.emit("post",n),e&&e(n)}}function u(t,e){if(d._subscribed){var n=d.find(t.id);n?(Object.deepExtend(n,t),d.commit(),n.emit("merge",n),d.emit("merge",n)):(n=new o(d,t),d.models.push(n),d.commit()),n.emit("put"),e&&e(n)}}function c(t,e){if(d._subscribed){var n=d.find(t.id);n&&(Object.deepExtend(n,t),d.commit(),n.emit("merge",n),d.emit("merge",n),e&&e(n))}}function f(t){i.localStorage.setItem(l,"[]"),d.models.splice(0,d.models.length),d.emit("clear"),t&&t()}function p(t,e){d.emit("broadcast",t.payload),e&&e(t.payload)}function a(){d._subscribed&&d.subscribe(d._options)}function h(t){console.error(t)}this._options={},Object.deepExtend(this._options,n||{});var d=this,l=this._key="cmd_"+e;if(/[^a-zA-Z0-9-_\.]/g.test(e))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this.models=[],this._socket=[],this._events={},this._filter,this._subscribed=!1;var m=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+e,{multiplex:!1});m.path=e,m.on("sync",r),m.on("post",s),m.on("put",u),m.on("delete",c),m.on("clear",f),m.on("broadcast",p),m.on("reconnect",a),m.on("cmderror",h),m.on("sync",function(t){r(t,function(t){d.emit("receipt:sync")})}),m.on("receipt:post",function(t){s(t,function(t){t.emit("receipt:post",t)})}),m.on("receipt:put",function(t){u(t,function(t){t.emit("receipt:put",t)})}),m.on("receipt:delete",function(t){c(t,function(t){t.emit("receipt:delete",t)})}),m.on("receipt:clear",function(){f(function(){d.emit("receipt:clear")})}),m.on("receipt:broadcast",function(t){p(t,function(t){d.emit("receipt:broadcast",t)})})};s.prototype=Object.create(e.prototype),s.prototype.load=function(t){var e=this,n=i.localStorage.getItem(this._key);if(t&&this.once("load",t,this),n){var r=JSON.parse(n).map(function(t){return new o(e,t)});this._filter&&(r=i.sift(this._filter,r)),r.unshift(0),r.unshift(this.models.length),this.models.splice.apply(this.models,r)}this.emit("load",this.models)},s.prototype.commit=function(t){t&&this.once("commit",t);var e=this.models.map(function(t){return t.get()});i.localStorage.setItem(this._key,JSON.stringify(e)),this.emit("commit")},s.prototype.subscribe=function(t,e){function n(){i._options=t||{},i._filter=i._options.filter,i._socket.emit("subscribe",i._options),i.emit("subscribed"),i._subscribed=!0,i.sync(e)}"function"==typeof t&&(e=t,t={});var i=this;return this._subscribed?this.unsubscribe(n):n(),this},s.prototype.unsubscribe=function(t){return t&&this._socket.once("unsubscribe",t),this.models.splice(0,this.models.length),this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},s.prototype.sync=function(t){this.load();var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return t&&this.once("receipt:sync",t),this._socket.emit("sync",e),this},s.prototype.post=function(t,e){var n=new o(this);return e&&n.once("receipt:post",e),n.post(t),this},s.prototype.create=function(t,e){return this.post({attributes:t},e),this},s.prototype.put=function(t,e,n){var i=this.find(t);return i&&(n&&i.once("receipt:put",n),i.put(e)),this},s.prototype["delete"]=function(t,e){var n=this.find(t);return n&&(e&&n.once("receipt:delete",e),n["delete"]()),this},s.prototype.clear=function(t){return t&&this.once("receipt:clear",t),this._socket.emit("clear"),this},s.prototype.broadcast=function(t,e){return e&&this.once("receipt:broadcast",e),this._socket.emit("broadcast",{payload:t}),this},s.prototype.close=function(){return this._socket.close("close"),this},s.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},s.prototype.where=function(t){return new u(this,t)};var u=function(t,e){this.models=[],this._filter=e,this._endpoint=t,this._events={};var n=this;this._endpoint.on("subscribed",function(){n.run(),n.emit("subscribed")}),this._endpoint.on("unsubscribed",function(){n.run(),n.emit("unsubscribed")}),this._endpoint.on("sync",function(t){n.run(),n.emit("sync",t)}),this._endpoint.on("post",function(t){n.run(),n.emit("post",t)}),this._endpoint.on("put",function(t){n.run(),n.emit("put",t)}),this._endpoint.on("delete",function(t){n.run(),n.emit("put",t)}),this._endpoint.on("clear",function(){n.run(),n.emit("clear")}),this._endpoint.on("merge",function(){n.run(),n.emit("merge")}),this.run.call(n)};u.prototype=Object.create(e.prototype),u.prototype.run=function(){return this.models=this._endpoint.models.filter(this._filter),this},u.prototype.put=function(t){return this.models.forEach(function(e){e.put(t)}),this},u.prototype["delete"]=function(){return this.models.forEach(function(t){t["delete"]()}),this},t.Model=o,t.Query=u,t.Endpoint=s,t.Utils=i});