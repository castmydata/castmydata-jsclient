!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CastMyData=t.CastMyData||{})}(this,function(t){var e,n={};if("object"==typeof t&&"undefined"!=typeof module){var i=require("node-localstorage").LocalStorage;e=new i("./scratch")}else e=window.localStorage;!function(t){"use strict";function e(t){return"function"==typeof t}function n(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(t){return t instanceof Date?t.getTime():t instanceof Array?t.map(i):t}function r(t,e){return t.get?t.get(e):t[e]}function o(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var o=0,s=i.length;s>o;o++)if(t(e,r(i,o)))return!0;return!1}}function s(t){return function(e,i){if(!n(i)||!i.length)return t(e,i);for(var o=0,s=i.length;s>o;o++)if(!t(e,r(i,o)))return!1;return!0}}function u(t,e){return t.v(t.a,e)}function c(t,e){for(var n=0;n<t.length;n++)if(u(e,r(t,n)))return n;return-1}function f(t,e){return{a:t,v:e}}function a(t,e){var n=[];return p(e,t.k,0,n),1===n.length?u(t.nv,n[0]):!!~c(n,t.nv)}function p(t,e,i,o){if(i===e.length||void 0==t)return void o.push(t);var s=r(e,i);if(n(t)&&isNaN(Number(s)))for(var u=0,c=t.length;c>u;u++)p(r(t,u),e,i,o);else p(r(t,s),e,i+1,o)}function h(t,e){return{a:{k:t,nv:e},v:a}}function d(t){t=i(t),(!t||"Object"!==t.constructor.toString()&&"functionObject(){[nativecode]}"!==t.constructor.toString().replace(/\n/g,"").replace(/ /g,""))&&(t={$eq:t});var e=[];for(var n in t){var r=t[n];if("$options"!==n)if(v[n])y[n]&&(r=y[n](r,t)),e.push(f(i(r),v[n]));else{if(36===n.charCodeAt(0))throw new Error("Unknown operation "+n);e.push(h(n.split("."),d(r)))}}return 1===e.length?e[0]:f(e,v.$and)}function l(t,e){var n=d(t);return e&&(n={a:n,v:function(t,n){return u(t,e(n))}}),n}function m(t,n,i){function r(t){return u(o,t)}e(n)&&(i=n,n=void 0);var o=l(t,i);return n?n.filter(r):r}var v={$eq:o(function(t,e){return t(e)}),$ne:s(function(t,e){return!t(e)}),$or:function(t,e){for(var n=0,i=t.length;i>n;n++)if(u(r(t,n),e))return!0;return!1},$gt:o(function(t,e){return m.compare(i(e),t)>0}),$gte:o(function(t,e){return m.compare(i(e),t)>=0}),$lt:o(function(t,e){return m.compare(i(e),t)<0}),$lte:o(function(t,e){return m.compare(i(e),t)<=0}),$mod:o(function(t,e){return e%t[0]==t[1]}),$in:function(t,e){if(!(e instanceof Array))return!!~t.indexOf(i(e));for(var n=e.length;n--;)if(~t.indexOf(i(r(e,n))))return!0;return!1},$nin:function(t,e){return!v.$in(t,e)},$not:function(t,e){return!u(t,e)},$type:function(t,e){return void 0!=e?e instanceof t||e.constructor==t:!1},$all:function(t,e){e||(e=[]);for(var n=t.length;n--;)if(!~i(e).indexOf(r(t,n)))return!1;return!0},$size:function(t,e){return e?t===e.length:!1},$nor:function(t,e){for(var n=0,i=t.length;i>n;n++)if(u(r(t,n),e))return!1;return!0},$and:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!u(r(t,n),e))return!1;return!0},$regex:o(function(t,e){return"string"==typeof e&&t.test(e)}),$where:function(t,e){return t.call(e,e)},$elemMatch:function(t,e){return n(e)?!!~c(e,t):u(t,e)},$exists:function(t,e){return void 0!=e===t}},y={$eq:function(t){return t instanceof RegExp?function(e){return"string"==typeof e&&t.test(e)}:t instanceof Function?t:n(t)&&!t.length?function(t){return n(t)&&!t.length}:null===t?function(t){return null==t}:function(e){return 0===m.compare(i(e),t)}},$ne:function(t){return y.$eq(t)},$and:function(t){return t.map(d)},$or:function(t){return t.map(d)},$nor:function(t){return t.map(d)},$not:function(t){return d(t)},$regex:function(t,e){return new RegExp(t,e.$options)},$where:function(t){return"string"==typeof t?new Function("obj","return "+t):t},$elemMatch:function(t){return d(t)},$exists:function(t){return!!t}};m.use=function(t){if(e(t))return t(m);for(var n in t)36===n.charCodeAt(0)&&(v[n]=t[n])},m.indexOf=function(t,e,n){return c(e,l(t,n))},m.compare=function(t,e){if(t===e)return 0;if(typeof t==typeof e){if(t>e)return 1;if(e>t)return-1}},t.sift=m}(n),function(t){"use strict";function n(t){var e,n=[],i={};for(e in t)n.push([e,t[e]]);n.sort(function(t,e){return e[1]-t[1]});for(e in n)i[n[e][0]]=n[e][1];return i}function i(t){var e,n=t[t.length-1],r=t.substring(0,t.length-1);return"undefined"==typeof n?e="a":"z"===n?e="A":"Z"===n?(e="a",r=""!==r?i(r):"a"):e=String.fromCharCode(n.charCodeAt(0)+1),n=e,r+n}function r(t){var e,r,o={},s="",u=t.match(c);for(e in u)u[e].length>s.length+2&&("undefined"!=typeof o[u[e]]?o[u[e]]+=1:o[u[e]]=0);r=n(o);for(e in r)s=i(s),r[e]=f+s+f;return r}function o(t,e){var n,i;for(n in e)i=new RegExp(n,"g"),t=t.replace(i,e[n]);return t}function s(t,e){var n,i;for(n in e)i=new RegExp(e[n],"g"),t=t.replace(i,n);return t}function u(){this.setItem=function(t,n,i){var s,u,c;return"undefined"!=typeof i&&"no-beautify"===i||(u=JSON.parse(n),n=JSON.stringify(u)),c=r(n),s=o(n,c),"undefined"!=typeof i&&"local-dict"===i?a[t]=c:e.setItem(t,s),"undefined"==typeof a[t]&&e.setItem("d_"+t,JSON.stringify(c)),s},this.getItem=function(t){var n,i;return n=e.getItem(t),i="undefined"==typeof a[t]?JSON.parse(e.getItem("d_"+t)):a[t],s(n,i)},this.getDict=function(t){var n;return n="undefined"==typeof a[t]?JSON.parse(e.getItem("d_"+t)):a[t]},this.setDict=function(t,n,i){"undefined"==typeof i?e.setItem("d_"+t,n):a[t]=n}}var c=/\"[a-zA-Z0-9]*\":/g,f="Â£",a={};t.JJLC=new u}(n),n.localStorage=n.JJLC,function(t){for(var e=[],n=0;15>=n;n++)e[n]=n.toString(16);var i={v4:function(){for(var t="",n=1;36>=n;n++)t+=9===n||14===n||19===n||24===n?"-":15===n?4:20===n?e[4*Math.random()|8]:e[15*Math.random()|0];return t}};t.uuid=i}(n);var r=function(){function t(t){this.head=new e,this.tail=new e(this.head),this.head.next=this.tail,this.linkConstructor=t,this.reg={}}function e(t,e,i){this.prev=t,this.next=e,this.fn=i||n}function n(){}function i(){this._events={}}var r=0;return t.prototype={insert:function(t){var n=new e(this.tail.prev,this.tail,t);return n.next.prev=n.prev.next=n,n},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev}},e.prototype.run=function(t){this.fn(t),this.next&&this.next.run(t)},i.prototype={on:function(e,n){var i=this;return e.split(/\W+/g).forEach(function(e){var o=i._events[e]||(i._events[e]=new t),s=n._eev||(n._eev=++r);o.reg[s]||(o.reg[s]=o.insert(n))}),this},off:function(t,e){var n=this;return t.split(/\W+/g).forEach(function(t){var i=n._events[t],r=i.reg[e._eev];i.reg[e._eev]=void 0,i&&r&&i.remove(r)}),this},emit:function(t,e){var n=this._events[t];return n&&n.head.run(e),this}},i}();Object.deepExtend=function(t,e){for(var n in e)e[n]&&e[n].constructor&&e[n].constructor===Object?(t[n]=t[n]||{},arguments.callee(t[n],e[n])):t[n]=e[n];return t};var o=function(t,e){e=e||{},this.id=e.id||n.uuid.v4(),this.attributes=e.attributes||{},this.meta=e.meta||{},this._events={},this._endpoint=t};o.prototype=Object.create(r.prototype),o.prototype.get=function(){return JSON.parse(JSON.stringify({id:this.id,attributes:this.attributes,meta:this.meta}))},o.prototype.post=function(t){t.meta={synced:!1,createdAt:Date.now(),updatedAt:Date.now(),deletedAt:null},Object.deepExtend(this,t),this._endpoint.models.push(this),this._endpoint.commit(),this.emit("post",this),this._endpoint.emit("post",this),this._endpoint._socket.emit("post",this.get())},o.prototype.put=function(t){Object.deepExtend(this,t),this.meta.synced=!1,this.meta.updatedAt=Date.now(),this._endpoint.commit(),this.emit("put",this,t),this._endpoint.emit("put",this,t),this._endpoint._socket.emit("put",this.get())},o.prototype["delete"]=function(){this.attributes={},this.meta.deletedAt=Date.now(),this.meta.synced=!1,this._endpoint.commit(),this.emit("delete",this),this._endpoint.emit("delete",this),this._endpoint._socket.emit("delete",this.id)},o.prototype.merge=function(t){return JSON.stringify(this.attributes)!=JSON.stringify(t.attributes)||JSON.stringify(this.meta)!=JSON.stringify(t.meta)?(Object.deepExtend(this,t),this._endpoint.commit(),this.emit("merge",this),this._endpoint.emit("merge",this),!0):!1};var s=function(t,e,i){function r(t){if(s._subscribed){var e=s.find(t.id);e?e.merge(t):(e=new o(s,t),s.models.push(e),s.commit(),e.emit("post",e),s.emit("post",e))}}this._options={},Object.deepExtend(this._options,i||{});var s=this,u=this._key="cmd_"+e;if(/[^a-zA-Z0-9-_\.]/g.test(e))throw"Invalid characters in path. Allowed characters are a-z, A-Z, 0-9, -, _, .";this.models=[],this._socket=[],this._events={},this._filter,this._subscribed=!1;var c=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path="+e,{multiplex:!1});c.path=e,c.on("post",r),c.on("sync",function(t){if(s._subscribed){t.forEach(function(t){r(t)});s.emit("sync",s.models)}}),c.on("put",function(t){if(s._subscribed){var e=s.find(t.id);e?(Object.deepExtend(e,t),s.commit(),e.emit("merge",e),s.emit("merge",e)):r(t)}}),c.on("delete",function(t){if(s._subscribed){var e=s.find(t.id);e&&(Object.deepExtend(e,t),s.commit(),e.emit("merge",e),s.emit("merge",e))}}),c.on("clear",function(){n.localStorage.setItem(u,"[]"),s.models.splice(0,s.models.length),s.emit("clear")}),c.on("broadcast",function(t){s.emit("broadcast",t.payload)}),c.on("reconnect",function(){s._subscribed&&s.subscribe(s._options)}),c.on("cmderror",function(t){console.error(t)})};s.prototype=Object.create(r.prototype),s.prototype.load=function(){var t=this,e=n.localStorage.getItem(this._key);if(e){var i=JSON.parse(e).map(function(e){return new o(t,e)});this._filter&&(i=n.sift(this._filter,i)),i.unshift(0),i.unshift(this.models.length),this.models.splice.apply(this.models,i),this.emit("load",this.models)}},s.prototype.commit=function(){var t=this.models.map(function(t){return t.get()});n.localStorage.setItem(this._key,JSON.stringify(t))},s.prototype.subscribe=function(t){return this._options=t||{},this._filter=this._options.filter,this._subscribed&&this.unsubscribe(),this._socket.emit("subscribe",this._options),this.emit("subscribed"),this._subscribed=!0,this.sync(),this},s.prototype.unsubscribe=function(){return this.models.splice(0,this.models.length),this._socket.emit("unsubscribe"),this.emit("unsubscribed"),this._subscribed=!1,this},s.prototype.sync=function(t){this.load();var e=this.models.filter(function(t){return!t.meta.synced}).map(function(t){return t.get()});return this._socket.emit("sync",e),this},s.prototype.find=function(t){return this.models.filter(function(e){return e.id==t}).pop()},s.prototype.where=function(t){return new u(this,t)},s.prototype.post=function(t){var e=new o(this);return e.post(t),this},s.prototype.create=function(t){return this.post({attributes:t}),this},s.prototype.put=function(t,e){var n=this.find(t);return n&&n.put(e),this},s.prototype["delete"]=function(t){var e=this.find(t);return e&&e["delete"](),this},s.prototype.clear=function(){return this._socket.emit("clear"),this},s.prototype.broadcast=function(t){return this._socket.emit("broadcast",{payload:t}),this},s.prototype.close=function(){return this._socket.close("close"),this};var u=function(t,e){this.models=[],this._filter=e,this._endpoint=t,this._events={};var n=this;this._endpoint.on("subscribed",function(){n.run.call(n),n.emit("subscribed")}),this._endpoint.on("unsubscribed",function(){n.run.call(n),n.emit("unsubscribed")}),this._endpoint.on("sync",function(){n.run.call(n);var t=Array.prototype.slice.call(arguments);t.unshift("sync"),n.emit.apply(n,t)}),this._endpoint.on("post",function(){n.run.call(n);var t=Array.prototype.slice.call(arguments);t.unshift("post"),n.emit.apply(n,t)}),this._endpoint.on("put",function(){n.run.call(n);var t=Array.prototype.slice.call(arguments);t.unshift("put"),n.emit.apply(n,t)}),this._endpoint.on("delete",function(){n.run.call(n);var t=Array.prototype.slice.call(arguments);t.unshift("delete"),n.emit.apply(n,t)}),this._endpoint.on("clear",function(){n.run.call(n),n.emit("clear")}),this._endpoint.on("merge",function(){n.run.call(n),n.emit("merge")}),this.run.call(n)};u.prototype=Object.create(r.prototype),u.prototype.run=function(){return this.models=this._endpoint.models.filter(this._filter),this},u.prototype.put=function(t){return this.models.forEach(function(e){e.put(t)}),this},u.prototype["delete"]=function(){return this.models.forEach(function(t){t["delete"]()}),this},t.Model=o,t.Query=u,t.Endpoint=s,t.Utils=n});